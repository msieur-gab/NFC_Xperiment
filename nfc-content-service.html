<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NFC Key Encryption Service</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        .section { margin-bottom: 20px; }
        textarea { width: 100%; height: 150px; }
        .message-list { 
            border: 1px solid #ddd; 
            padding: 10px; 
            margin-top: 10px; 
        }
        .encrypted-message {
            background-color: #f0f0f0;
            padding: 10px;
            margin: 5px 0;
            word-break: break-all;
        }
        .decrypted-message {
            background-color: #e6f3e6;
            padding: 10px;
            margin: 5px 0;
        }
        .status-message {
            color: blue;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>NFC Key Encryption Service</h1>

    <div class="section" id="nfcReadSection">
        <h2>NFC Interaction</h2>
        <button onclick="scanNFCTag('read')">Scan NFC Tag to Read</button>
        <button onclick="scanNFCTag('write')">Scan NFC Tag to Write</button>
    </div>

    <div id="status" class="status-message"></div>

    <div class="section" id="contentSection" style="display:none;">
        <div id="readContent">
            <h2>Stored Messages</h2>
            <div id="encryptedMessageList" class="message-list">
                <h3>Encrypted Messages</h3>
            </div>
            <div id="decryptedMessageList" class="message-list">
                <h3>Decrypted Messages</h3>
            </div>
        </div>

        <div id="writeContent" style="display:none;">
            <h2>Write New Message</h2>
            <textarea id="messageInput" placeholder="Enter message to encrypt"></textarea>
            <button onclick="writeMessage()">Encrypt and Store</button>
        </div>
    </div>

    <script>
        let currentNFCKey = null;
        let currentMode = null;

        async function scanNFCTag(mode) {
            currentMode = mode;
            document.getElementById('status').textContent = `Scan NFC Tag for ${mode} operation`;

            if ('NDEFReader' in window) {
                try {
                    const ndef = new NDEFReader();
                    await ndef.scan();

                    ndef.addEventListener("reading", async ({ message }) => {
                        const decoder = new TextDecoder();
                        const tagData = JSON.parse(
                            decoder.decode(message.records[0].data)
                        );

                        // Extract encryption key from NFC tag
                        currentNFCKey = CryptoJS.AES.decrypt(
                            tagData.ownerKey, 
                            'system-master-key'
                        ).toString(CryptoJS.enc.Utf8);

                        document.getElementById('status').textContent = 'NFC Tag Read Successfully';
                        document.getElementById('contentSection').style.display = 'block';

                        if (mode === 'read') {
                            await displayMessages();
                            document.getElementById('writeContent').style.display = 'none';
                            document.getElementById('readContent').style.display = 'block';
                        } else {
                            document.getElementById('writeContent').style.display = 'block';
                            document.getElementById('readContent').style.display = 'none';
                        }
                    });

                } catch (error) {
                    document.getElementById('status').textContent = `NFC Error: ${error}`;
                }
            } else {
                document.getElementById('status').textContent = 'NFC not supported on this device';
            }
        }

        async function displayMessages() {
            const encryptedList = document.getElementById('encryptedMessageList');
            const decryptedList = document.getElementById('decryptedMessageList');
            
            // Clear previous messages
            encryptedList.innerHTML = '<h3>Encrypted Messages</h3>';
            decryptedList.innerHTML = '<h3>Decrypted Messages</h3>';

            // Get all encrypted message keys
            const keys = await localforage.keys();
            const encryptedKeys = keys.filter(key => key.startsWith('encrypted_'));

            for (const key of encryptedKeys) {
                const storedContent = await localforage.getItem(key);

                // Display encrypted message
                const encryptedDiv = document.createElement('div');
                encryptedDiv.className = 'encrypted-message';
                encryptedDiv.textContent = storedContent;
                encryptedList.appendChild(encryptedDiv);

                // Try to decrypt with NFC tag key
                try {
                    const decryptedContent = CryptoJS.AES.decrypt(
                        storedContent, 
                        currentNFCKey
                    ).toString(CryptoJS.enc.Utf8);

                    const decryptedDiv = document.createElement('div');
                    decryptedDiv.className = 'decrypted-message';
                    decryptedDiv.textContent = decryptedContent;
                    decryptedList.appendChild(decryptedDiv);
                } catch (decryptError) {
                    console.error('Decryption failed:', decryptError);
                }
            }
        }

        async function writeMessage() {
            if (!currentNFCKey) {
                alert('Scan NFC tag first');
                return;
            }

            const message = document.getElementById('messageInput').value;
            
            // Generate unique hash
            const hash = CryptoJS.SHA256(message + Date.now()).toString().substring(0, 12);

            // Encrypt with NFC tag key
            const encryptedMessage = CryptoJS.AES.encrypt(
                message, 
                currentNFCKey
            ).toString();

            // Store encrypted message
            await localforage.setItem(
                `encrypted_${hash}`, 
                encryptedMessage
            );

            document.getElementById('messageInput').value = '';
            document.getElementById('status').textContent = 'Message encrypted and stored';

            // Refresh messages
            await displayMessages();
        }
    </script>
</body>
</html>
